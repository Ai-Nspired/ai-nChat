<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ai-n Forge | Modal Yard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body{background:#000;color:#fff;overflow:hidden;height:100dvh;margin:0;font-family:system-ui}
    .yard{position:fixed;inset:0;margin:auto;width:92vmin;height:92vmin;border:3px solid rgba(250,204,21,.2);pointer-events:none;z-index:1}
    .modal-content{background:#000;border:none;display:flex;flex-direction:column;height:100%;padding:0;overflow:hidden}
    .modal-header{background:rgba(30,30,50,.8);border-bottom:1px solid #facc15;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;cursor:move;flex-shrink:0;user-select:none}
    .modal-title{font-size:28px;font-weight:300;color:#fff;margin:0;flex:1;text-align:center}
    .content-area{flex:1;overflow-y:auto;padding:20px;background:rgba(10,10,20,.6)}
    .content-area::-webkit-scrollbar{width:8px}.content-area::-webkit-scrollbar-thumb{background:#facc15;border-radius:4px}
    .input-group{position:relative;padding:0 20px 20px;flex-shrink:0}
    .truth-input{width:100%;height:140px;background:rgba(0,0,0,.3);border:2px solid #facc15;border-radius:32px;color:#fff;padding:20px 80px 20px 20px;font-size:18px;resize:none;outline:none;font-family:monospace}
    .send-btn{position:absolute;right:20px;bottom:20px;width:55px;height:55px;background:#facc15;color:#000;border:none;border-radius:50%;font-size:24px;font-weight:900;cursor:pointer}
    .forgebar{position:fixed;left:12px;top:50%;transform:translateY(-50%);background:rgba(30,30,50,.95);border:2px solid #facc15;border-radius:16px;padding:16px 8px;z-index:1000;display:flex;flex-direction:column;gap:20px}
    .forgebar button{background:transparent;border:none;color:#facc15;font-size:28px;cursor:pointer}
    .forgebar button:hover{color:#fff;transform:scale(1.2)}
    #count{writing-mode:vertical-rl;font-weight:900;color:#facc15;font-size:18px}
    .resizer{position:absolute;bottom:4px;right:4px;width:16px;height:16px;cursor:se-resize;z-index:10}
    .resizer::after{content:"";position:absolute;inset:0;border:2px solid #facc15;border-top:none;border-left:none}
    .minimized .content-area,.minimized .input-group,.minimized .resizer{display:none!important}
    .minimized .modal-dialog{width:max-content!important;height:64px!important;min-width:220px!important}
    .minimized .modal-header{border-radius:32px;justify-content:center;backdrop-filter:blur(20px);border:2px solid #facc15}
    .chat-message{margin:12px 0;padding:12px;border-radius:12px;max-width:95%;position:relative}
    .user{background:rgba(59,130,246,.2);margin-left:auto;border-left:4px solid #3b82f6}
    .ai{background:rgba(250,204,21,.15);border-left:4px solid #facc15;position:relative}
    .modal-fs .modal-dialog{position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100dvh!important;max-width:none!important;margin:0!important}
    .copy-btn,.tts-btn,.stop-btn{position:absolute;top:5px;background:#facc15;color:#000;border:none;border-radius:4px;padding:2px 6px;font-size:12px;cursor:pointer}
    .copy-btn{right:5px}
    .tts-btn{right:35px}
    .stop-btn{right:65px;display:none}
    .header-btn{background:transparent;border:none;color:#fff;font-size:20px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;margin-left:5px}
    .header-btn.close{color:#ff4444}
  </style>
</head>
<body>

<div class="yard"></div>

<div class="forgebar">
  <button onclick="forge.create('agent')" title="AI Agent">ü§ñ</button>
  <button onclick="forge.create('doc')" title="Document">üìÑ</button>
  <button onclick="forge.clear()" title="Clear All">üóëÔ∏è</button>
  <div id="count">0</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
class Forge {
  constructor() {
    this.nodes = [];
    this.z = 1000;
    this.sessionId = crypto.randomUUID();
    this.currentUtterance = null;
  }

  create(type) {
    const id = Date.now();
    const node = { id, type, sessionId: this.sessionId };
    this.nodes.push(node);
    this.updateCount();
    this.render(node);
  }

  updateCount() {
    document.getElementById('count').textContent = this.nodes.length;
  }

  render(node) {
    const modalDiv = document.createElement('div');
    modalDiv.className = 'modal';
    modalDiv.id = `m-${node.id}`;
    modalDiv.style.zIndex = this.z++;

    modalDiv.innerHTML = `
      <div class="modal-dialog" style="position:absolute;left:20%;top:20%;width:60%;height:75%;">
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-title" contenteditable="true">${node.type === 'agent' ? 'AI Agent' : 'Document'}</div>
            <div>
              <button class="header-btn" onclick="forge.toggleMinimize(${node.id})" title="Minimize">‚àí</button>
              <button class="header-btn" onclick="forge.toggleFS(${node.id})" title="Fullscreen">‚õ∂</button>
              <button class="header-btn close" onclick="forge.remove(${node.id})" title="Close">‚úï</button>
            </div>
          </div>
          <div class="content-area" id="content-${node.id}"></div>
          ${node.type === 'agent' ? `
          <div class="input-group">
            <textarea class="truth-input" id="input-${node.id}" placeholder="Ask or write..."></textarea>
            <button class="send-btn" onclick="forge.send(${node.id})">‚û§</button>
          </div>` : ''}
          <div class="resizer"></div>
        </div>
      </div>`;

    document.body.appendChild(modalDiv);
    const modal = new bootstrap.Modal(modalDiv, { backdrop: false, keyboard: false });
    modal.show();

    node.modal = modal;
    node.contentEl = modalDiv.querySelector(`#content-${node.id}`);
    node.input = modalDiv.querySelector(`#input-${node.id}`);
    node.dialog = modalDiv.querySelector('.modal-dialog');

    this.makeDraggable(node);
    this.makeResizable(node);
    this.makeScrollable(node);

    if (node.type === 'agent') {
      this.appendMessage(node, 'ai', "I'm ready to assist you. Type your message below.");
    }
  }

  appendMessage(node, role, text) {
    const div = document.createElement('div');
    div.className = `chat-message ${role}`;

    if (role === 'ai') {
      div.innerHTML = `
        <button class="copy-btn" onclick="forge.copyMessage(this)">‚éò</button>
        <button class="tts-btn" onclick="forge.speakMessage(this)">üîä</button>
        <button class="stop-btn" onclick="forge.stopSpeech()">üîá</button>
        ${marked.parse(text)}
      `;
    } else {
      div.innerHTML = marked.parse(text);
    }

    node.contentEl.appendChild(div);
    node.contentEl.scrollTop = node.contentEl.scrollHeight;
  }

  copyMessage(button) {
    const message = button.closest('.chat-message');
    const text = message.textContent.replace('‚éò', '').replace('üîä', '').replace('üîá', '').trim();
    navigator.clipboard.writeText(text).then(() => {
      button.textContent = '‚úì';
      setTimeout(() => button.textContent = '‚éò', 2000);
    });
  }

  speakMessage(button) {
    if (this.currentUtterance) {
      speechSynthesis.cancel();
    }

    const message = button.closest('.chat-message');
    const text = message.textContent.replace('‚éò', '').replace('üîä', '').replace('üîá', '').trim();

    if (!text || !('speechSynthesis' in window)) return;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.0;
    utterance.onstart = () => {
      button.style.display = 'none';
      button.nextElementSibling.style.display = 'block';
    };
    utterance.onend = () => {
      button.style.display = 'block';
      button.nextElementSibling.style.display = 'none';
    };

    this.currentUtterance = utterance;
    speechSynthesis.speak(utterance);
  }

  stopSpeech() {
    if (this.currentUtterance) {
      speechSynthesis.cancel();
      document.querySelectorAll('.tts-btn').forEach(btn => {
        btn.style.display = 'block';
        if (btn.nextElementSibling) btn.nextElementSibling.style.display = 'none';
      });
    }
  }

  async send(id) {
    const node = this.nodes.find(n => n.id === id);
    if (!node) return;
    const query = node.input.value.trim();
    if (!query) return;

    this.appendMessage(node, 'user', query);
    node.input.value = '';
    this.appendMessage(node, 'ai', 'thinking...');

    try {
      const res = await fetch("https://ai-proxy.ai-n.workers.dev/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: query, sessionId: this.sessionId })
      });
      const data = await res.json();
      const answer = data.response || data.answer || "no response";

      node.contentEl.lastChild.innerHTML = `
        <button class="copy-btn" onclick="forge.copyMessage(this)">‚éò</button>
        <button class="tts-btn" onclick="forge.speakMessage(this)">üîä</button>
        <button class="stop-btn" onclick="forge.stopSpeech()">üîá</button>
        ${marked.parse(answer)}
      `;
      node.contentEl.scrollTop = node.contentEl.scrollHeight;

    } catch (e) {
      node.contentEl.lastChild.textContent = "error: " + e.message;
    }
  }

  makeDraggable(node) {
    const header = node.modal._dialog.querySelector('.modal-header');
    let pos = {};
    let isDragging = false;

    const move = (e) => {
      if (!isDragging) return;
      const x = e.clientX || e.touches[0].clientX;
      const y = e.clientY || e.touches[0].clientY;

      const newLeft = (parseFloat(node.dialog.style.left || 20) + (x - pos.x)/window.innerWidth*100);
      const newTop = (parseFloat(node.dialog.style.top || 20) + (y - pos.y)/window.innerHeight*100);

      node.dialog.style.left = `${Math.max(0, Math.min(100 - parseFloat(node.dialog.style.width || 60), newLeft))}%`;
      node.dialog.style.top = `${Math.max(0, Math.min(100 - parseFloat(node.dialog.style.height || 75), newTop))}%`;

      pos = { x, y };
    };

    header.addEventListener('pointerdown', (e) => {
      if (e.target.tagName === 'BUTTON') return;
      isDragging = true;
      pos = { x: e.clientX || e.touches[0].clientX, y: e.clientY || e.touches[0].clientY };
      header.style.cursor = 'grabbing';
      document.addEventListener('pointermove', move);
      document.addEventListener('pointerup', () => {
        isDragging = false;
        header.style.cursor = '';
        document.removeEventListener('pointermove', move);
      });
    });
  }

  makeResizable(node) {
    const resizer = node.dialog.querySelector('.resizer');
    let pos = {};
    const resize = (e) => {
      const newWidth = parseFloat(node.dialog.style.width || 60) + (e.clientX - pos.x)/window.innerWidth*100;
      const newHeight = parseFloat(node.dialog.style.height || 75) + (e.clientY - pos.y)/window.innerHeight*100;

      node.dialog.style.width = `${Math.max(20, Math.min(100, newWidth))}%`;
      node.dialog.style.height = `${Math.max(20, Math.min(100, newHeight))}%`;

      pos = { x: e.clientX, y: e.clientY };
    };
    resizer.addEventListener('pointerdown', (e) => {
      e.stopPropagation();
      pos = { x: e.clientX, y: e.clientY };
      document.addEventListener('pointermove', resize);
      document.addEventListener('pointerup', () => document.removeEventListener('pointermove', resize));
    });
  }

  makeScrollable(node) {
    node.contentEl.style.overflowY = 'auto';
  }

  toggleMinimize(id) {
    const node = this.nodes.find(n => n.id === id);
    if (node) {
      node.modal._element.classList.toggle('minimized');
      this.updateCount();
    }
  }

  toggleFS(id) {
    const node = this.nodes.find(n => n.id === id);
    if (node) node.modal._element.classList.toggle('modal-fs');
  }

  remove(id) {
    const node = this.nodes.find(n => n.id === id);
    if (node) {
      node.modal.hide();
      setTimeout(() => {
        node.modal._element.remove();
        this.nodes = this.nodes.filter(n => n.id !== id);
        this.updateCount();
      }, 300);
    }
  }

  clear() {
    if (confirm('Clear yard?')) this.nodes.forEach(n => this.remove(n.id));
  }
}

const forge = new Forge();
</script>
</body>
</html>